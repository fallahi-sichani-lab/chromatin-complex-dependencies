```{r}
suppressPackageStartupMessages({
  library(data.table)
  library(readxl)
  library(dplyr)
  library(tidyr)
  library(readr)
  library(stringr)
  library(tibble)
  library(limma)
  library(pheatmap)
  library(ggplot2)
  library(ggrepel)
})

set.seed(42)

# =========================
# Paths
# =========================
IN_DIR <- "."
FN_CR  <- file.path(IN_DIR, "CRISPRGeneDependency.csv")
FN_MD  <- file.path(IN_DIR, "Model.csv")
FN_EPI <- file.path(IN_DIR, "EpiGenes_main.xlsx")
FN_EPI_COMPLEX <- file.path(IN_DIR, "EpiGenes_complexes.xlsx")

OUT_DIR <- "manuscript_out"
dir.create(OUT_DIR, showWarnings = FALSE, recursive = TRUE)

# =========================
# Parameters
# =========================
MIN_PER_LINEAGE   <- 5
EXCLUDE_LINEAGES  <- c("NON-CANCEROUS")
USE_ONLY_EPIGENES <- TRUE

FDR_SIG  <- 0.10   # volcano significance (Melanoma)
FDR_MARK <- 0.10   # "*" markers in heatmap
ZLIM     <- 5      # heatmap saturation limit

# =========================
# Helpers
# =========================
# Normalize gene symbols / labels to a consistent uppercase format (used for matching)
norm_sym <- function(x) {
  x <- toupper(as.character(x))
  x <- gsub("\\(.*?\\)", "", x, perl = TRUE)
  x <- gsub("[^A-Z0-9-]", "-", x, perl = TRUE)
  x <- gsub("-+", "-", x, perl = TRUE)
  x <- gsub("^-|-$", "", x, perl = TRUE)
  trimws(x)
}

# Standardize lineage strings: lowercase then capitalize only the first letter
process_string <- function(s) {
  s <- tolower(s)
  gsub("^(\\w)", "\\U\\1", s, perl = TRUE)
}

# =========================
# Load CRISPR dependency matrix
# =========================
# Read wide dependency matrix: rows = cell lines, columns = genes
crispr_raw <- data.table::fread(FN_CR, check.names = TRUE)

# Identify the cell line ID column used to join metadata
id_col <- intersect(
  c("DepMap_ID", "depmap_id", "ModelID", "model_id", "ACH_ID", "ACH", "V1"),
  names(crispr_raw)
)[1]

# Clean gene headers and normalize formatting
gene_cols_raw <- setdiff(names(crispr_raw), id_col)
gene_clean <- gsub("\\.\\.[0-9]+\\.$", "", gene_cols_raw)
gene_clean <- gsub("\\.+", "-", gene_clean)
gene_clean <- norm_sym(gene_clean)
names(crispr_raw)[match(gene_cols_raw, names(crispr_raw))] <- gene_clean

# Merge duplicate gene columns created by header cleaning (row-wise mean)
dup_names <- unique(gene_clean[duplicated(gene_clean)])
if (length(dup_names)) {
  for (gn in dup_names) {
    cols <- which(names(crispr_raw) == gn)
    crispr_raw[[gn]] <- rowMeans(crispr_raw[, ..cols], na.rm = TRUE)
    if (length(cols) > 1) crispr_raw <- crispr_raw[, -cols[-1], with = FALSE]
  }
}

# Convert gene columns to numeric and standardize NaN values as NA
gene_cols <- setdiff(names(crispr_raw), id_col)
for (g in gene_cols) crispr_raw[[g]] <- suppressWarnings(as.numeric(crispr_raw[[g]]))
for (g in gene_cols) crispr_raw[[g]][is.nan(crispr_raw[[g]])] <- NA_real_

dep_df <- as_tibble(crispr_raw) %>%
  rename(DepMap_ID = !!id_col) %>%
  mutate(CellLine = as.character(DepMap_ID))

# =========================
# Load metadata and filter lineages
# =========================
# Attach lineage annotations from Model.csv
model <- data.table::fread(FN_MD, check.names = FALSE)

model_keys <- model %>%
  transmute(
    DepMap_ID = as.character(ModelID),
    Lineage   = coalesce(OncotreePrimaryDisease, OncotreeLineage)
  ) %>%
  distinct()

dat0 <- dep_df %>%
  left_join(model_keys, by = c("CellLine" = "DepMap_ID"))

# Drop excluded lineages (e.g., NON-CANCEROUS)
dat0 <- dat0 %>%
  mutate(Lineage_norm = norm_sym(Lineage)) %>%
  filter(!(Lineage_norm %in% norm_sym(EXCLUDE_LINEAGES))) %>%
  select(-Lineage_norm)

# Keep lineages with enough cell lines for one-vs-rest modeling
keep_lin <- dat0 %>%
  distinct(CellLine, Lineage) %>%
  count(Lineage, name = "n") %>%
  filter(n >= MIN_PER_LINEAGE) %>%
  pull(Lineage)

dat0 <- dat0 %>%
  filter(Lineage %in% keep_lin)

# =========================
# Load epigenetic gene list and gene→complex mapping
# =========================
# Build a gene-to-complex membership table from EpiGenes_main.xlsx
epi_raw <- readxl::read_xlsx(FN_EPI)
nm_lower <- tolower(names(epi_raw))

hgnc_col <- names(epi_raw)[which(nm_lower %in% c("hgnc_symbol", "hgnc", "symbol", "gene", "gene_symbol"))[1]]
cx_col   <- names(epi_raw)[which(nm_lower %in% c("complex_name", "complex", "complexes"))[1]]

epi_map <- tibble(
  SYMBOL  = norm_sym(epi_raw[[hgnc_col]]),
  Complex = as.character(epi_raw[[cx_col]])
) %>%
  filter(!is.na(SYMBOL), SYMBOL != "", !is.na(Complex), Complex != "") %>%
  separate_rows(Complex, sep = "\\s*[;,]\\s*") %>%
  mutate(Complex = str_squish(Complex)) %>%
  filter(Complex != "") %>%
  distinct(SYMBOL, Complex)

# Restrict dependency matrix to epigenetic genes only
keep_genes <- intersect(
  epi_map$SYMBOL,
  setdiff(names(dat0), c("CellLine", "DepMap_ID", "Lineage"))
)

# Optional: attach Complex_Group annotations (if needed later for grouping/plots)
epi_cx <- readxl::read_xlsx(FN_EPI_COMPLEX)
nm_lower <- tolower(names(epi_cx))

cx_col2 <- names(epi_cx)[which(nm_lower %in% c("complex_name"))[1]]
gp_col2 <- names(epi_cx)[which(nm_lower %in% c("group_name"))[1]]

epi_cx_clean <- epi_cx %>%
  transmute(
    Complex_norm  = norm_sym(.data[[cx_col2]]),
    Complex_Group = str_squish(as.character(.data[[gp_col2]]))
  ) %>%
  filter(!is.na(Complex_norm), Complex_norm != "") %>%
  distinct(Complex_norm, .keep_all = TRUE)

epi_map <- epi_map %>%
  mutate(Complex_norm = norm_sym(Complex)) %>%
  left_join(epi_cx_clean, by = "Complex_norm") %>%
  select(-Complex_norm)

# =========================
# Convert dependency matrix to long format
# =========================
# Create tidy dependency table: one row per (CellLine, Lineage, Gene)
dep_long <- dat0 %>%
  select(CellLine, Lineage, all_of(keep_genes)) %>%
  pivot_longer(cols = all_of(keep_genes), names_to = "Gene", values_to = "Score") %>%
  mutate(Gene = norm_sym(Gene)) %>%
  filter(is.finite(Score))

# =========================
# Complex-level limma (one-vs-rest)
# =========================
# Map genes to complexes and compute mean complex score per cell line
dep_long_cx <- dep_long %>%
  inner_join(epi_map, by = c("Gene" = "SYMBOL")) %>%
  filter(!is.na(Complex), Complex != "")

cellline_complex <- dep_long_cx %>%
  group_by(CellLine, Lineage, Complex) %>%
  summarise(dep_score = mean(Score, na.rm = TRUE), .groups = "drop")

# Build CellLine × Complex matrix for limma
mat_cx <- cellline_complex %>%
  pivot_wider(names_from = Complex, values_from = dep_score) %>%
  column_to_rownames("CellLine") %>%
  as.matrix()
storage.mode(mat_cx) <- "double"

sample_ann <- cellline_complex %>%
  distinct(CellLine, Lineage) %>%
  arrange(match(CellLine, rownames(mat_cx)))

design <- model.matrix(~ 0 + Lineage, data = sample_ann)
colnames(design) <- sub("^Lineage", "", colnames(design))

# One-vs-rest contrast matrix across lineages
lineages <- colnames(design)
Cmat <- sapply(lineages, function(li) {
  v <- rep(-1 / (length(lineages) - 1), length(lineages))
  names(v) <- lineages
  v[li] <- 1
  v
})

fit  <- lmFit(t(mat_cx), design)
fit2 <- contrasts.fit(fit, Cmat)
fit2 <- eBayes(fit2, robust = TRUE)

# Export complex-level limma results
limma_out <- lapply(seq_along(lineages), function(i) {
  lin <- lineages[i]
  topTable(fit2, coef = i, number = Inf, sort.by = "none") %>%
    rownames_to_column("Complex") %>%
    mutate(Lineage = lin)
}) %>%
  bind_rows()

write_csv(limma_out, file.path(OUT_DIR, "limma_complex_cellline_one_vs_rest.csv"))

# =========================
# Clean lineage labels (for plotting)
# =========================
limma_out_clean <- limma_out %>%
  filter(!is.na(Complex), Complex != "", Complex != "Lineage") %>%
  mutate(Lineage = sapply(Lineage, process_string))

# =========================
# Lineage abbreviations (for heatmap labels)
# =========================
# Optional improvement: move this to a CSV file (e.g., lineage_abbrev.csv with Lineage,Abbrev)
# abbrev_df <- read_csv(file.path(IN_DIR, "lineage_abbrev.csv"))
# abbrev_map <- setNames(abbrev_df$Abbrev, abbrev_df$Lineage)

abbrev_map <- c(
  "Acute myeloid leukemia" = "AML",
  "Ampullary carcinoma" = "AMP",
  "Anaplastic thyroid cancer" = "ATC",
  "B-cell acute lymphoblastic leukemia" = "B-ALL",
  "Bladder urothelial carcinoma" = "BLAD",
  "Cervical squamous cell carcinoma" = "CESC",
  "Colorectal adenocarcinoma" = "CRC",
  "Cutaneous squamous cell carcinoma" = "cSCC",
  "Diffuse glioma" = "GLIO",
  "Embryonal tumor" = "EMB",
  "Endometrial carcinoma" = "ENDO",
  "Esophageal squamous cell carcinoma" = "ESCC",
  "Esophagogastric adenocarcinoma" = "EGA",
  "Ewing sarcoma" = "EWS",
  "Head and neck squamous cell carcinoma" = "HNSC",
  "Hepatocellular carcinoma" = "LIHC",
  "Intracholecystic papillary neoplasm" = "ICPN",
  "Intraductal papillary neoplasm of the bile duct" = "IPNB",
  "Invasive breast carcinoma" = "BRCA",
  "Liposarcoma" = "LIPO",
  "Lung neuroendocrine tumor" = "LNET",
  "Mature b-cell neoplasms" = "MBN",
  "Mature t and nk neoplasms" = "MTNK",
  "Melanoma" = "MEL",
  "Myeloproliferative neoplasms" = "MPN",
  "Nerve sheath tumor" = "NST",
  "Neuroblastoma" = "NB",
  "Non-hodgkin lymphoma" = "NHL",
  "Non-seminomatous germ cell tumor" = "NSGCT",
  "Non-small cell lung cancer" = "NSCLC",
  "Ocular melanoma" = "OCM",
  "Osteosarcoma" = "OSTEO",
  "Ovarian epithelial tumor" = "OV",
  "Pancreatic adenocarcinoma" = "PAAD",
  "Pleural mesothelioma" = "MESO",
  "Prostate adenocarcinoma" = "PRAD",
  "Renal cell carcinoma" = "RCC",
  "Rhabdoid cancer" = "RHAB",
  "Rhabdomyosarcoma" = "RMS",
  "Synovial sarcoma" = "SS",
  "T-lymphoblastic leukemia/lymphoma" = "T-LBL",
  "Undifferentiated pleomorphic sarcoma" = "UPS"
)

# =========================
# Heatmap prep
# =========================
BRKS <- seq(-ZLIM, ZLIM, length.out = 201)
PAL  <- colorRampPalette(c("white", "white", "#00ACC1"))(length(BRKS) - 1)

# Build Lineage × Complex matrix from limma logFC
mat_fc <- limma_out_clean %>%
  group_by(Lineage, Complex) %>%
  summarise(logFC = mean(logFC, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = Complex, values_from = logFC) %>%
  as.data.frame()

rownames(mat_fc) <- mat_fc$Lineage
mat_fc$Lineage <- NULL
mat_fc <- as.matrix(mat_fc)

# Add "(n=)" labels using gene membership table
complex_sizes <- epi_map %>%
  distinct(Complex, SYMBOL) %>%
  count(Complex, name = "n_genes")

cx0 <- colnames(mat_fc)
cx_n <- complex_sizes$n_genes[match(cx0, complex_sizes$Complex)]
cx_labels <- ifelse(is.na(cx_n), cx0, paste0(cx0, " (n=", cx_n, ")"))
colnames(mat_fc) <- cx_labels

# Rename heatmap rows to "Lineage (ABBREV)"
row_lab <- paste0(rownames(mat_fc), " (", abbrev_map[rownames(mat_fc)], ")")
row_lab[grepl("\\(NA\\)", row_lab)] <- rownames(mat_fc)[grepl("\\(NA\\)", row_lab)]
rownames(mat_fc) <- row_lab

# Build "*" annotation matrix for positive significant complexes
sig_ann <- limma_out_clean %>%
  mutate(mark = ifelse(adj.P.Val <= FDR_MARK & logFC > 0, "*", "")) %>%
  group_by(Lineage, Complex) %>%
  summarise(mark = paste(mark, collapse = ""), .groups = "drop") %>%
  pivot_wider(names_from = Complex, values_from = mark, values_fill = "") %>%
  as.data.frame()

sig_ann$RowLabel <- paste0(sig_ann$Lineage, " (", abbrev_map[sig_ann$Lineage], ")")
sig_ann$RowLabel[grepl("\\(NA\\)", sig_ann$RowLabel)] <- sig_ann$Lineage[grepl("\\(NA\\)", sig_ann$RowLabel)]
rownames(sig_ann) <- sig_ann$RowLabel
sig_ann$Lineage <- NULL
sig_ann$RowLabel <- NULL

colnames(sig_ann) <- cx_labels
sig_ann <- sig_ann[rownames(mat_fc), colnames(mat_fc), drop = FALSE]

# Row-wise Z-score across lineages
mat_z <- t(scale(t(mat_fc)))
mat_z[is.na(mat_z)] <- 0

# =========================
# Plot: Complex limma heatmap
# =========================
pdf(file.path(OUT_DIR, "complex_limma_heatmap.pdf"), width = 15, height = 6)
pheatmap(
  mat_z,
  color = PAL,
  breaks = BRKS,
  display_numbers = sig_ann,
  number_color = "black",
  fontsize_number = 8,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  border_color = NA,
  main = "",
  fontsize_row = 7,
  fontsize_col = 6,
  angle_col = 45
)
dev.off()

# =========================
# Plot: Melanoma volcano (complex-level)
# =========================
mel_cx <- limma_out_clean %>%
  filter(Lineage == "Melanoma") %>%
  mutate(
    neglog10FDR = -log10(adj.P.Val),
    significant = (adj.P.Val <= FDR_SIG & logFC > 0)
  )

xmax <- max(abs(mel_cx$logFC), na.rm = TRUE) * 1.1
ymax <- max(mel_cx$neglog10FDR, na.rm = TRUE) * 1.1

p_mel <- ggplot(mel_cx, aes(x = logFC, y = neglog10FDR)) +
  geom_point(
    data = subset(mel_cx, !significant),
    color = "gray80",
    alpha = 0.6,
    size = 2
  ) +
  geom_point(
    data = subset(mel_cx, significant),
    color = "#26C6DA",
    size = 3
  ) +
  geom_text_repel(
    data = subset(mel_cx, significant),
    aes(label = Complex),
    size = 3.5,
    max.overlaps = Inf,
    point.padding = 0.3
  ) +
  geom_hline(yintercept = -log10(FDR_SIG), linetype = "dashed", color = "gray60") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray60") +
  theme_classic(base_size = 8) +
  labs(
    title = "",
    x = "Mean dependency (melanoma - others)",
    y = "-log10(FDR)"
  ) +
  xlim(-0.05, xmax) +
  ylim(0, ymax)

pdf(
  file.path(OUT_DIR, sprintf("melanoma_complex_volcano_FDR%.2f.pdf", FDR_SIG)),
  width = 3,
  height = 3
)
print(p_mel)
dev.off()
```